
# Input the data
F1_1 <- c(0.0964, 0.0631, 0.0318, 0.0594, 0.0161, 0.0365, 0.0695, 0.0690, 0.0247, 0.0412, 0.1003, 0.0524, 0.0193, 0.0343, 0.0480, 0.0797, 0.0467, 0.0121, 0.0253, 0.0741)
F2_1 <- c(0.0736301,0.0420659,0.0116857,0.00577884,0.0344768,0.0165771,0.0115874,0.0101828,0.0224098,0.125036,0.239506,0.00575243,0.0349387,0.0624289,0.0108474,0.0138127,0.0350863,0.0156735,0.0288336,0.19969)
F2_2 <- c(0.104035,0.0677371,0.0351037,0.0696185,0.0133054,0.0403634,0.0816521,0.0844854,0.0249323,0.0224157,0.066655,0.0620534,0.016237,0.0280571,0.0570639,0.0945127,0.049348,0.0118271,0.0245534,0.0460435)

F4_1 <- c(0.0920548,0.0553379,0.0318206,0.102457,0.00424498,0.0474943,0.119906,0.0734557,0.0188388,0.0201987,0.0561906,0.0754587,0.011812,0.0151568,0.0827026,0.0771459,0.0530929,0.00922952,0.011699,0.0417034)
F4_2 <- c(0.120477,0.0954101,0.0311517,0.0273694,0.0231719,0.0354826,0.040009,0.0944352,0.0354261,0.0220833,0.0866637,0.0494555,0.0241434,0.0485782,0.0272253,0.111013,0.0411052,0.0092355,0.031916,0.0456485)
F4_3 <- c(0.0646654,0.0218516,0.0176792,0.00771314,0.0325835,0.00968293,0.00998289,0.00825001,0.0119701,0.144137,0.235644,0.00401432,0.0299925,0.0462406,0.0127392,0.0107412,0.0323113,0.0295715,0.0429975,0.227232)
F4_4 <- c(1.75769e-05,0.147647,0.129944,0.01579,1.75769e-05,0.0316547,0.0698645,1.75769e-05,1.75769e-05,0.0914882,0.0368789,0.00748561,0.175769,1.75769e-05,0.065751,0.0360197,0.00290522,0.175769,1.75769e-05,0.0129274)

F8_1 <- c(0.0409033,0.0741969,0.0434624,0.101881,0.000138938,0.022723,0.0946703,0.130574,0.0198531,0.0447982,0.0211775,0.0765398,0.0102916,0.0292618,0.0553716,0.0936222,0.0203023,0.0121394,0.00590734,0.102186)
F8_2 <- c(0.122502,0.0864211,0.0131459,0.0296206,0.0420945,0.0236167,0.0318566,0.0716423,0.0518304,0.0200462,0.0745208,0.038587,0.0171778,0.0698471,0.00301989,0.137943,0.0345708,0.00893058,0.0661968,0.0564306)
F8_3 <- c(0.114751,0.0686446,0.0415785,0.0161699,0.00517152,0.0276677,0.0394709,0.0823982,0.0304912,0.0304595,0.0861152,0.0249556,0.0317259,0.0370365,0.138003,0.0916131,0.0297506,0.0266675,0.025516,0.051813)
F8_4 <- c(0.0384331,0.0523653,0.0296283,0.0589677,0.0209695,0.0590616,0.0948627,0.0793419,0.0284203,0.0270875,0.117713,0.0505763,7.85388e-05,0.00119073,0.0758,0.0850565,0.087913,0.0110557,0.0237146,0.0577635)
F8_5 <- c(0.190276,0.0977501,0.0313586,0.0436719,0.00390739,0.0634842,0.0779924,0.0622719,0.02192,0.0270238,0.104425,0.0936782,0.00473012,0.0166865,7.10101e-05,0.0820929,0.0262918,7.10101e-05,7.10101e-05,0.0522263)
F8_6 <- c(0.0848343,0.0622641,0.0329319,0.0860776,0.0186342,0.0407838,0.0452183,0.0599726,0.0250711,0.016412,0.107643,0.0652168,0.0539769,0.043927,0.0287562,0.0927383,0.0785924,0.0124281,6.04519e-05,0.044461)
F8_7 <- c(0.132455,0.0381045,0.0185515,0.106785,0.00130499,0.0387726,0.155934,0.0371834,0.00391036,0.0312659,0.0407655,0.0590639,0.0160001,0.0209356,0.0667009,0.040664,0.0565702,0.0191919,0.0628537,0.0529865)
F8_8 <- c(0.0626289,0.0256797,0.024621,0.00695919,0.0405735,0.00495012,0.00915175,0.0264558,0.00924011,0.153982,0.252472,0.000297637,0.0315357,0.0529799,0.0116112,0.00252614,0.0249839,0.0155478,0.0248986,0.218906)

F10_1 <- c(0.0951815,0.0898734,0.0400739,0.0566552,0.0258627,0.0411491,0.036316,0.0295645,0.0290678,0.0244669,0.103115,0.0879412,0.0510774,0.00973801,0.00399189,0.106363,0.094909,0.00392678,0.00909412,0.0616326)
F10_2 <- c(0.0791651,0.0633787,0.0307722,0.0000875455,0.0249962,0.0248807,0.0281768,0.0856778,0.0346434,0.0447194,0.156142,0.00275651,0.0653901,0.0871013,0.0752194,0.0587292,0.014828,0.0225379,0.0364103,0.0643878)
F10_3 <- c(0.159865,0.0947391,0.0507743,0.0344274,0.0000920482,0.0141003,0.0567542,0.0809695,0.0293498,0.0195388,0.100466,0.0527175,0.00881687,0.0000920482,0.0564458,0.098429,0.0371892,0.0212744,0.0162594,0.0676994)
F10_4 <- c(0.122953,0.0696851,0.00342007,0.0580904,0.0449335,0.0220916,0.0288058,0.0568581,0.0566351,0.0221778,0.0608678,0.0501054,0.00571208,0.0674747,0.0113555,0.14012,0.0391373,0.00707712,0.0639785,0.0685206)
F10_5 <- c(0.0691583,0.021993,0.0269766,0.0127757,0.0509711,0.00632125,0.00521974,0.0145802,0.00394856,0.167407,0.246906,0.000308235,0.0250452,0.0419772,0.0104131,0.00718915,0.0290562,0.0115716,0.021482,0.2267)
F10_6 <- c(0.131608,0.0996116,0.0161474,0.0455742,0.0064738,0.0880735,0.0813327,0.0648054,0.0188262,0.0296626,0.130996,0.0737761,0.0119013,0.0405873,0.000091681,0.0771084,0.0158113,0.000091681,0.000091681,0.0674293)
F10_7 <- c(0.0378795,0.0678643,0.0435899,0.112753,0.000130103,0.0217906,0.0843666,0.12107,0.00807882,0.0607061,0.0224495,0.067956,0.0199518,0.0218261,0.061458,0.0841364,0.0134502,0.00794212,0.0469138,0.0956877)
F10_8 <- c(0.0899257,0.0361378,0.0107289,0.0990157,0.00101999,0.0404787,0.135411,0.0476142,0.0109771,0.0290578,0.0611128,0.0409312,0.0168603,0.0224945,0.0770708,0.0587654,0.0982625,0.0155625,0.05368,0.0548929)
F10_9 <- c(0.147919,0.045668,0.0354327,0.0892718,0.00187309,0.0421802,0.140897,0.0473804,0.021272,0.016008,0.027086,0.0873209,0.0126555,0.0515414,0.0703138,0.0492243,0.0320147,0.0228702,0.0000802069,0.0589904)
F10_10 <- c(0.0342052,0.0404088,0.0418635,0.044969,0.0243696,0.0529587,0.069029,0.129522,0.0261134,0.0232404,0.100453,0.0458736,0.0000813327,0.0000813327,0.105747,0.102512,0.0647891,0.0218914,0.0120732,0.0598184)

C10_1 <- c(0.4082573125, 0.0081783015, 0.0096285438, 0.0069870889, 0.0349388179, 0.0075279735, 0.0097846653, 0.1221613215, 0.0039151830, 0.0125784287, 0.0158338663, 0.0059670150, 0.0081313216, 0.0061604332, 0.0394155867, 0.1682450664, 0.0658132542, 0.0018751587, 0.0041579747, 0.0604426865)
C10_2 <- c(0.1027763487, 0.0418664491, 0.0213272051, 0.0155943616, 0.0149663448, 0.0440685478, 0.0419667447, 0.0138805792, 0.0158864807, 0.1066076641, 0.1131944125, 0.0436343681, 0.0437800327, 0.0180729309, 0.0223250701, 0.0529608087, 0.1081741005, 0.0045147205, 0.0137373857, 0.1606654446)
C10_3 <- c(0.0351766018, 0.0019678632, 0.0016591476, 0.0006768741, 0.0078706538, 0.0016559557, 0.0019686768, 0.0022420602, 0.0012878339, 0.3515819591, 0.1278183107, 0.0018856550, 0.0242631753, 0.0126221329, 0.0029771559, 0.0049998099, 0.0255378034, 0.0011907778, 0.0037539283, 0.3888636245)
C10_4 <- c(0.0408513927, 0.0269887074, 0.2185648186, 0.2333814790, 0.0037602852, 0.0380451418, 0.0901238869, 0.1158332065, 0.0373197176, 0.0025523644, 0.0052164616, 0.0485017266, 0.0022571778, 0.0025108218, 0.0108333610, 0.0804527209, 0.0302879995, 0.0010815260, 0.0069890931, 0.0044481118)
C10_5 <- c(0.0185492661, 0.0062362395, 0.0024895723, 0.0009775062, 0.0070416514, 0.0083539447, 0.0024891617, 0.0028952913, 0.0040103982, 0.1632422345, 0.4443079409, 0.0043570878, 0.1202815687, 0.0733329781, 0.0048827648, 0.0051642443, 0.0131806647, 0.0068759784, 0.0144734420, 0.0968580644)
C10_6 <- c(0.1106750119, 0.0352190043, 0.0405186210, 0.1636437899, 0.0014834855, 0.0877962201, 0.2638456592, 0.0325228293, 0.0163803600, 0.0068334902, 0.0140679579, 0.0677158208, 0.0048988133, 0.0023256777, 0.0298982139, 0.0562887953, 0.0426922497, 0.0010338979, 0.0040522304, 0.0181078719)
C10_7 <- c(0.0522657662, 0.0668294648, 0.0714836849, 0.0297745257, 0.0143324928, 0.0736540298, 0.0388386669, 0.0228101108, 0.1551638111, 0.0187406149, 0.0653779932, 0.0439469345, 0.0207189121, 0.0624033021, 0.0145475497, 0.0549017631, 0.0370140058, 0.0193756900, 0.1110694548, 0.0267512268)
C10_8 <- c(0.0116587342, 0.0050990142, 0.0064011054, 0.0021742457, 0.0105340743, 0.0040203734, 0.0024251112, 0.0034709143, 0.0366787049, 0.0187185330, 0.0676489746, 0.0026694717, 0.0143534813, 0.3650985596, 0.0031159927, 0.0094848536, 0.0073713920, 0.0509564551, 0.3574858593, 0.0206341497)
C10_9 <- c(0.0627195947, 0.2038782162, 0.0428629162, 0.0236193294, 0.0052662886, 0.1098111767, 0.0686284994, 0.0256174957, 0.0332612124, 0.0128968249, 0.0305627740, 0.2270839355, 0.0124036991, 0.0039181841, 0.0140440613, 0.0483152469, 0.0463378087, 0.0025143473, 0.0065521118, 0.0197062770)
C10_10 <- c(0.1145518598, 0.0324008908, 0.0750614981, 0.0416192189, 0.0098549497, 0.0339624663, 0.0364907910, 0.0503817581, 0.0165233329, 0.0092949460, 0.0139153707, 0.0423026886, 0.0082240805, 0.0046605982, 0.0379221548, 0.2610647896, 0.1845829279, 0.0017548981, 0.0058538316, 0.0195769483)

# Add row names and column names to the matrix
profile_matrix <- rbind(F1_1, F2_1, F2_2, F4_1, F4_2, F4_3, F4_4,
                        #F8_1, F8_2, F8_3, F8_4, F8_5, F8_6, F8_7, F8_8,
                        F10_1, F10_2, F10_3, F10_4, F10_5, F10_6, F10_7, F10_8, F10_9, F10_10
                        #,C10_1, C10_2, C10_3, C10_4, C10_5, C10_6, C10_7, C10_8, C10_9, C10_10
                        )
rownames(profile_matrix) <- c("F1.1 (1.0000)", "F2.1 (0.1916)", "F2.2 (0.8084)", "F4.1 (0.4291)", "F4.2 (0.3900)", "F4.3 (0.1793)", "F4.4 (0.0015)",
                              #"F8.1 (0.1227)", "F8.2 (0.1245)", "F8.3 (0.1257)", "F8.4 (0.1255)", "F8.5 (0.1251)", "F8.6 (0.1250)", "F8.7 (0.1265)", "F8.8 (0.1249)",
                              "F10.1 (0.0999)", "F10.2 (0.0984)", "F10.3 (0.1004)", "F10.4 (0.0990)", "F10.5 (0.0988)", "F10.6 (0.1010)", "F10.7 (0.0992)", "F10.8 (0.1017)", "F10.9 (0.1014)", "F10.10 (0.1001)"
                              #,"C10.1 (0.1191)", "C10.2 (0.0874)", "C10.3 (0.1037)", "C10.4 (0.0923)", "C10.5 (0.1070)", "C10.6 (0.1330)", "C10.7 (0.0538)", "C10.8 (0.0692)", "C10.9 (0.1320)", "C10.10 (0.1024)"
                              )
amino_acids <- c("A", "R", "N", "D", "C", "Q", "E", "G", "H", "I", "L", "K", "M", "F", "P", "S", "T", "W", "Y", "V")
colnames(profile_matrix) <- amino_acids

library(ggtree)
library(ape)
library(ComplexHeatmap)
library(circlize)
library(viridis)

# Define KL divergence function
kl_dist <- function(p, q) {
  p <- p + 1e-10
  q <- q + 1e-10
  sum(p * log(p / q), na.rm = TRUE)
}

# Initialize KL divergence matrix
kl_matrix <- matrix(0, nrow(profile_matrix), nrow(profile_matrix))
rownames(kl_matrix) <- rownames(profile_matrix)
colnames(kl_matrix) <- rownames(profile_matrix)

# Calculate KL divergence between each pair of profiles
for(i in 1:nrow(profile_matrix)) {
  for(j in 1:nrow(profile_matrix)) {
    kl_matrix[i, j] <- kl_dist(profile_matrix[i, ], profile_matrix[j, ])
  }
}

# Perform clustering using the calculated KL divergence matrix
hc <- hclust(as.dist(kl_matrix), method = "complete")


# Plot One: The ComplexHeatmap Plot
# Define colors for each group
group_colors <- c("F1" = "red",
                  "F10" = "blue",
                  #"C10" = "purple",
                  "F2" = "black",
                  "F4" = "black",
                  "F8" = "black")

# Extract groups from the row names
group_labels <- sub("\\..*", "", rownames(profile_matrix))  # Extract the F group

# Create a vector of colors corresponding to the groups
row_colors <- group_colors[group_labels]

# Create the heatmap with adjusted row height
Heatmap(profile_matrix,
        cluster_rows = as.dendrogram(hc),  # Row clustering
        cluster_columns = TRUE,            # Column clustering
        show_row_dend = TRUE,              # Show row dendrogram
        show_column_dend = FALSE,          # Do not show column dendrogram
        row_dend_width = unit(3, "cm"),    # Adjust the width of the row dendrogram
        row_gap = unit(1, "mm"),           # Increase space between rows
        height = unit(17, "cm"),           # Increase the overall height of the heatmap
        heatmap_legend_param = list(title = "",
                                    labels_gp = gpar(fontsize = 8)),
        row_names_gp = gpar(fontsize = 8.5, fontfamily = "Helvetica", col = row_colors),  # Apply the color to row labels
        column_names_gp = gpar(fontsize = 8.5, fontfamily = "Helvetica"),
        column_names_rot = 0,
        column_names_side = "bottom",  # Place the column labels at the bottom
        column_names_centered = TRUE,  # Center the column labels
        col = viridis(4)
)


# Plot Two: The Chord Diagram
row_names <- rownames(kl_matrix)
col_names <- colnames(kl_matrix)
row_names_clean <- gsub("\\(.*\\)", "", row_names)
col_names_clean <- gsub("\\(.*\\)", "", col_names)
rownames(kl_matrix) <- row_names_clean
colnames(kl_matrix) <- col_names_clean

library(circlize)
labels <- rownames(kl_matrix)

# 颜色列表，假设每个部分都有一个唯一的颜色
colors <- rainbow(length(labels))

# 开始逐步显示每个部分



# 提取 F1 和 F2 之间的 KL 距离
f1_to_f2 <- kl_matrix["F1.1", c("F2.1", "F2.2")]

# 将 KL 距离取倒数作为流动强度
flow_strength <- 1 / f1_to_f2

# 构建一个流动矩阵
flow_matrix <- matrix(0, nrow = length(f1_to_f2), ncol = 2)
rownames(flow_matrix) <- c("F1.1")
colnames(flow_matrix) <- c("F2.1", "F2.2")

# 将计算出的流动强度填充到流动矩阵中
flow_matrix["F1.1", "F2.1"] <- flow_strength[1]
flow_matrix["F1.1", "F2.2"] <- flow_strength[2]

# 使用 circlize 包绘制弦图
library(circlize)
chordDiagram(flow_matrix)

